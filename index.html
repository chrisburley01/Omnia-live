<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Omnia ‚Äî AI Assistant</title>

  <!-- PWA (GitHub Pages absolute paths) -->
  <link rel="manifest" href="/Omnia-live/manifest.json" />
  <link rel="apple-touch-icon" href="/Omnia-live/icons/icon-180.png" />
  <meta name="theme-color" content="#0b0b0b" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          boxShadow: {
            glow: "0 0 0 2px rgba(99,102,241,.25), 0 0 30px rgba(99,102,241,.35)",
          },
          colors: {
            brand: { 500: "#6366f1", 400: "#818cf8" },
          },
        },
      },
    };
  </script>

  <style>
    * { -webkit-tap-highlight-color: transparent; }
    .glass { background: rgba(255,255,255,.06); backdrop-filter: blur(10px); }
    .gradient-ring {
      position: relative;
      border-radius: 16px;
      background: radial-gradient(1200px 200px at 50% 0%,
        rgba(99,102,241,.25), transparent 60%);
    }
    .type-cursor::after { content: '‚ñç'; animation: blink 1s steps(1) infinite; opacity: .7; }
    @keyframes blink { 50% { opacity: 0; } }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-b from-[#0b0b0f] to-black text-white">
  <!-- Top bar -->
  <header class="sticky top-0 z-40 glass border-b border-white/10">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-2xl bg-gradient-to-br from-sky-500/25 to-brand-500/25 grid place-items-center">‚ú®</div>
      <div class="leading-tight">
        <h1 class="text-lg font-semibold">Omnia</h1>
        <p class="text-[11px] text-white/60">Ask anything. Omnia gets it done.</p>
      </div>
      <div class="flex-1"></div>
      <div class="hidden sm:flex gap-2">
        <span class="px-2 py-1 text-[11px] rounded-full bg-white/10">Private</span>
        <span class="px-2 py-1 text-[11px] rounded-full bg-white/10">Unified ID</span>
        <span class="px-2 py-1 text-[11px] rounded-full bg-white/10">OmniPay</span>
      </div>
    </div>
  </header>

  <!-- Hero + Input -->
  <section class="max-w-5xl mx-auto px-4 pt-8 gradient-ring">
    <div class="text-center space-y-2">
      <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs text-white/70">
        <span>‚ö°</span> Omnia understands tasks & questions
      </div>
      <h2 class="text-2xl sm:text-3xl font-semibold">Ask Omnia anything‚Ä¶</h2>
      <p class="text-white/60 text-sm">Examples: <em>pay Ari 20 for lunch</em> ‚Ä¢ <em>ride to Heathrow at 8pm</em> ‚Ä¢ <em>order oat milk</em></p>
    </div>

    <div class="mt-5 relative">
      <form id="intentForm" class="relative">
        <input id="intentInput" autocomplete="off"
          class="w-full h-14 rounded-2xl pl-5 pr-28 bg-white/10 border border-white/10 placeholder-white/50 outline-none shadow-glow focus:shadow-glow"
          placeholder="Type a request or question‚Ä¶">
        <button class="absolute right-2 top-1/2 -translate-y-1/2 h-10 px-4 rounded-xl bg-white text-black font-medium">
          Ask
        </button>
      </form>

      <!-- suggestions -->
      <div id="suggestions" class="hidden absolute mt-2 w-full rounded-xl glass border border-white/10 overflow-hidden">
        <button data-s="pay Ari 20 for lunch" class="w-full text-left px-4 py-3 hover:bg-white/5 text-sm">üí≥ Pay Ari 20 for lunch</button>
        <button data-s="ride to Atocha at 7pm" class="w-full text-left px-4 py-3 hover:bg-white/5 text-sm">üöó Ride to Atocha at 7pm</button>
        <button data-s="order oat milk and eggs" class="w-full text-left px-4 py-3 hover:bg-white/5 text-sm">üõí Order oat milk and eggs</button>
        <button data-s="what's the weather tomorrow in London?" class="w-full text-left px-4 py-3 hover:bg-white/5 text-sm">üå¶Ô∏è Weather tomorrow in London?</button>
      </div>
    </div>
  </section>

  <!-- Chat / Results -->
  <main class="max-w-5xl mx-auto px-4 py-6">
    <div id="thread" class="space-y-4"></div>

    <!-- Quick actions -->
    <div class="mt-6 grid grid-cols-2 sm:grid-cols-3 gap-3">
      <button class="glass border border-white/10 rounded-xl p-4 text-left hover:bg-white/5" id="qaPay">
        <div class="text-2xl mb-1">üí≥</div>
        <div class="font-medium">Send money</div>
        <div class="text-xs text-white/60">OmniPay quick transfer</div>
      </button>
      <button class="glass border border-white/10 rounded-xl p-4 text-left hover:bg-white/5" id="qaRide">
        <div class="text-2xl mb-1">üöó</div>
        <div class="font-medium">Book a ride</div>
        <div class="text-xs text-white/60">Maps / Uber deeplink</div>
      </button>
      <button class="glass border border-white/10 rounded-xl p-4 text-left hover:bg-white/5" id="qaOrder">
        <div class="text-2xl mb-1">üõí</div>
        <div class="font-medium">Order groceries</div>
        <div class="text-xs text-white/60">Smart shopping list</div>
      </button>
    </div>
  </main>

  <!-- Bottom Sheet -->
  <div id="sheet" class="hidden fixed inset-0 z-50 bg-black/60 grid place-items-end">
    <div class="w-full max-w-xl bg-slate-900 border-t border-white/10 p-4 rounded-t-2xl">
      <div id="sheetBody"></div>
      <button id="closeSheet" class="w-full mt-4 h-11 rounded-xl bg-white/10">Close</button>
    </div>
  </div>

  <!-- Install banner -->
  <div id="installBanner" class="fixed bottom-3 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="glass border border-white/10 rounded-2xl px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-white/10 grid place-items-center">üì≤</div>
      <div class="text-sm">
        <div class="font-semibold">Install Omnia</div>
        <div class="text-white/60">Add to your home screen</div>
      </div>
      <div class="flex gap-2">
        <button id="installNow" class="px-3 py-2 rounded-xl bg-white text-black">Install</button>
        <button id="installLater" class="px-3 py-2 rounded-xl bg-white/10">Later</button>
      </div>
    </div>
  </div>

  <!-- Update toast -->
  <div id="updateToast" class="fixed bottom-3 left-1/2 -translate-x-1/2 z-50 hidden">
    <div class="glass border border-white/10 rounded-2xl px-4 py-3 flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-white/10 grid place-items-center">‚¨ÜÔ∏è</div>
      <div class="text-sm"><div class="font-semibold">Update available</div><div class="text-white/60">Tap to refresh</div></div>
      <button id="refreshApp" class="px-3 py-2 rounded-xl bg-white text-black">Refresh</button>
    </div>
  </div>

  <script>
    // --- Service worker (updates toast) ---
    let newWorker;
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/Omnia-live/service-worker.js").then((reg) => {
        reg.addEventListener("updatefound", () => {
          newWorker = reg.installing;
          newWorker.addEventListener("statechange", () => {
            if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
              document.getElementById("updateToast").classList.remove("hidden");
            }
          });
        });
      });
      navigator.serviceWorker.addEventListener("controllerchange", () => location.reload());
    }
    document.getElementById("refreshApp").onclick = () => {
      if (navigator.serviceWorker?.controller) {
        navigator.serviceWorker.controller.postMessage({ type: "SKIP_WAITING" });
      }
    };

    // --- Install banner ---
    let deferredPrompt = null;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault(); deferredPrompt = e;
      document.getElementById("installBanner").classList.remove("hidden");
    });
    document.getElementById("installNow").onclick = async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null;
      document.getElementById("installBanner").classList.add("hidden");
    };
    document.getElementById("installLater").onclick = () =>
      document.getElementById("installBanner").classList.add("hidden");

    // --- Simple local memory ---
    const memory = JSON.parse(localStorage.getItem("omnia:mem") || "{}");
    const saveMem = () => localStorage.setItem("omnia:mem", JSON.stringify(memory));

    // --- Helpers ---
    const thread = document.getElementById("thread");
    const sheet = document.getElementById("sheet");
    const sheetBody = document.getElementById("sheetBody");
    const openSheet = (html) => { sheetBody.innerHTML = html; sheet.classList.remove("hidden"); };
    const closeSheet = () => sheet.classList.add("hidden");
    document.getElementById("closeSheet").addEventListener("click", closeSheet);
    sheet.addEventListener("click", (e) => { if (e.target === sheet) closeSheet(); });

    function msgMine(text) {
      const el = document.createElement("div");
      el.className = "flex justify-end";
      el.innerHTML = `<div class="max-w-[85%] rounded-2xl bg-white text-black px-4 py-3">${text}</div>`;
      thread.appendChild(el);
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
    }
    function msgBot(text, thinking=false) {
      const el = document.createElement("div");
      el.className = "flex";
      el.innerHTML = `<div class="max-w-[85%] rounded-2xl glass border border-white/10 px-4 py-3">
        <div class="${thinking ? 'type-cursor' : ''}" id="botText">${thinking ? 'Omnia is thinking‚Ä¶' : text}</div>
      </div>`;
      thread.appendChild(el);
      window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
      return el.querySelector("#botText");
    }

    // --- Intent parsing ---
    function parseIntent(q) {
      const s = q.trim();
      if (!s) return { type: "none" };
      // pay <who> <amount> [for <note>]
      const pay = s.match(/^pay\s+(@?\w+)\s+([\d.,]+)(?:\s+for\s+(.+))?$/i);
      if (pay) return { type: "pay", to: pay[1], amount: parseFloat(pay[2].replace(",",".")), note: pay[3]||"" };
      const ride = s.match(/^ride\s+(?:to\s+)?(.+?)(?:\s+at\s+(.+))?$/i);
      if (ride) return { type: "ride", where: ride[1], when: ride[2] || "soon" };
      const order = s.match(/^order\s+(.+)$/i);
      if (order) return { type: "order", item: order[1] };
      const weather = s.match(/^weather(?:\s+in\s+(.+))?(?:\s+tomorrow)?\??$/i);
      if (weather) return { type: "weather", where: weather[1] || memory.city || "your area" };
      return { type: "question", text: s };
    }

    // --- Renderers / actions ---
    function renderPay(p = {}) {
      openSheet(`
        <h3 class="text-lg font-semibold">Send money</h3>
        <p class="text-sm text-white/60 mb-3">OmniPay secure transfer</p>
        <label class="text-xs text-white/60">Recipient</label>
        <input id="payTo" class="w-full h-11 rounded-md bg-white/10 px-3 mb-3" placeholder="@username or IBAN" value="${p.to||memory.lastRecipient||''}">
        <label class="text-xs text-white/60">Amount</label>
        <input id="payAmt" type="number" min="1" step="0.01" class="w-full h-11 rounded-md bg-white/10 px-3 mb-3" value="${p.amount||20}">
        <label class="text-xs text-white/60">Note</label>
        <input id="payNote" class="w-full h-11 rounded-md bg-white/10 px-3" placeholder="What‚Äôs this for?" value="${p.note||''}">
        <div class="flex gap-2 mt-4">
          <button id="sendNow" class="flex-1 h-11 rounded-xl bg-white text-black">Send</button>
          <a id="sendPaypal" class="flex-1 h-11 rounded-xl bg-white/10 grid place-items-center" target="_blank">PayPal</a>
        </div>
      `);
    }
    function renderRide(plan = {}) {
      const q = encodeURIComponent(plan.where || "Destination");
      openSheet(`
        <h3 class="text-lg font-semibold">Ride options</h3>
        <p class="text-sm text-white/60 mb-3">Destination: <b>${plan.where||'‚Äî'}</b> ‚Ä¢ When: <b>${plan.when||'soon'}</b></p>
        <div class="grid gap-2">
          <a class="px-3 py-3 rounded-xl bg-white/10 text-left block" target="_blank"
             href="https://www.google.com/maps/dir/?api=1&destination=${q}">Open in Google Maps</a>
          <a class="px-3 py-3 rounded-xl bg-white/10 text-left block" target="_blank"
             href="https://m.uber.com/ul/">Open Uber</a>
        </div>
        <button class="w-full mt-4 h-11 rounded-xl bg-white text-black" id="bookRide">Book best option</button>
      `);
    }
    function renderOrder(item) {
      openSheet(`
        <h3 class="text-lg font-semibold">Confirm order</h3>
        <p class="text-sm text-white/60">Groceries in ~25 minutes.</p>
        <ul class="list-disc ml-6 my-3 text-sm">
          <li>Oat milk</li><li>Eggs</li><li>Espresso pods</li>${item ? `<li><b>+ ${item}</b></li>` : ""}
        </ul>
        <div class="grid gap-2">
          <a class="px-3 py-3 rounded-xl bg-white/10 text-left block" target="_blank"
             href="https://www.amazon.co.uk/s?k=${encodeURIComponent(item||'oat milk eggs')}">Search Amazon</a>
          <a class="px-3 py-3 rounded-xl bg-white/10 text-left block" target="_blank"
             href="https://www.google.com/search?q=${encodeURIComponent(item||'groceries near me')}">Search Google</a>
        </div>
        <button class="w-full mt-4 h-11 rounded-xl bg-white text-black" id="payOrder">Pay with OmniPay</button>
      `);
    }

    // Delegate clicks inside sheet
    sheet.addEventListener("click", (e) => {
      if (e.target.id === "sendNow") {
        const to = document.getElementById("payTo").value.trim();
        const amt = parseFloat(document.getElementById("payAmt").value);
        if (!to) return alert("Enter recipient");
        if (!Number.isFinite(amt) || amt <= 0) return alert("Enter valid amount");
        memory.lastRecipient = to; saveMem();
        alert(`Sent ‚Ç¨${amt.toFixed(2)} to ${to}`); closeSheet();
      }
      if (e.target.id === "bookRide") { alert("Ride booked ‚Ä¢ driver en route üöó"); closeSheet(); }
      if (e.target.id === "payOrder") { alert("Order paid ‚Ä¢ ETA ~25 min"); closeSheet(); }
      if (e.target.id === "sendPaypal") {
        const to = document.getElementById("payTo").value.trim().replace(/^@/,'');
        const amt = document.getElementById("payAmt").value;
        e.target.href = `https://www.paypal.com/paypalme/${encodeURIComponent(to||'')}/${encodeURIComponent(amt||'')}`;
      }
    });

    // --- Suggestions ---
    const suggestions = document.getElementById("suggestions");
    const input = document.getElementById("intentInput");
    input.addEventListener("focus", () => suggestions.classList.remove("hidden"));
    input.addEventListener("blur", () => setTimeout(()=>suggestions.classList.add("hidden"), 150));
    suggestions.querySelectorAll("[data-s]").forEach(btn => {
      btn.addEventListener("click", () => { input.value = btn.dataset.s; suggestions.classList.add("hidden"); });
    });

    // --- Quick actions ---
    document.getElementById("qaPay").onclick = () => { msgMine("pay @ari 20 for lunch"); handleQuery("pay @ari 20 for lunch"); };
    document.getElementById("qaRide").onclick = () => { msgMine("ride to Atocha at 7pm"); handleQuery("ride to Atocha at 7pm"); };
    document.getElementById("qaOrder").onclick = () => { msgMine("order oat milk and eggs"); handleQuery("order oat milk and eggs"); };

    // --- Core: handle query ---
    function handleQuery(q) {
      const intent = parseIntent(q);
      const thinking = msgBot("Omnia is thinking‚Ä¶", true);

      setTimeout(() => {
        if (intent.type === "pay") {
          thinking.innerHTML = `Got it. Preparing to send <b>‚Ç¨${intent.amount.toFixed(2)}</b> to <b>${intent.to}</b>${intent.note ? ` for <b>${intent.note}</b>` : ""}.`;
          renderPay(intent);
          return;
        }
        if (intent.type === "ride") {
          thinking.innerHTML = `Sure. Finding rides to <b>${intent.where}</b> (${intent.when}).`;
          renderRide(intent);
          return;
        }
        if (intent.type === "order") {
          thinking.innerHTML = `Okay. Adding <b>${intent.item}</b> to your basket.`;
          renderOrder(intent.item);
          return;
        }
        if (intent.type === "weather") {
          thinking.innerHTML = `Weather in <b>${intent.where}</b> ‚Äî looks mild with a chance of clouds. (Demo)`;
          return;
        }
        if (intent.type === "question") {
          thinking.innerHTML = `Here‚Äôs what I found for: <b>${intent.text}</b>.`;
          const url = `https://www.google.com/search?q=${encodeURIComponent(intent.text)}`;
          thinking.insertAdjacentHTML("beforeend", `<div class="mt-2"><a class="underline" target="_blank" href="${url}">Open results ‚Üó</a></div>`);
          return;
        }
        thinking.innerHTML = "Please type a request.";
      }, 350);
    }

    // Form submit
    document.getElementById("intentForm").addEventListener("submit", (e) => {
      e.preventDefault();
      const q = input.value.trim();
      if (!q) return;
      msgMine(q);
      input.value = "";
      handleQuery(q);
    });
  </script>
</body>
</html>